use super::matrix::BitMatrix128;
struct XorShift128Rng {
    pub state0: u64,
    pub state1: u64,
}

impl XorShift128Rng {
    pub fn next(&mut self) -> (u64, u64) {
        let &mut Self { state0: mut s1, state1: s0 } = self;
        self.state0 = s0;
        s1 ^= s1 << 23;
        s1 ^= s1 >> 17;
        s1 ^= s0;
        s1 ^= s0 >> 26;
        self.state1 = s1;
        (s0, s1)
    }

    pub fn build_matrix() -> BitMatrix128 {
        let mut out = BitMatrix128::eye() >> 64; // state0 = state1
        let state1 = BitMatrix128::eye() << 64;
        out = out ^ state1;
        out = out ^ state1 << 23;
        out = out ^ (state1 << 23) >> 17;
        out = out ^ (state1 >> (64 + 17)) << 64;
        let state0 = BitMatrix128::eye().select(0..64);
        out = out ^ state0;                       // state1 ^= stat0
        out = out ^ (state0 >> 26).select(0..64); // state1 ^= state0 >> 26
        out
    }
}

pub fn invert(s0: u64, s1: u64) -> (u64, u64) {
    let matrix = XorShift128Rng::build_matrix().inv().unwrap();
    let state = (s1 as u128) << 64 | s0 as u128;
    let state = state * matrix;
    let s0 = ((state << 64) >> 64) as u64;
    let s1 = (state >> 64) as u64;
    (s0, s1)
}

#[cfg(test)]
mod test {
    use super::*;
    #[test]
    fn test_xs128_build_matrix() {
        let state0 = 0x1337133713371337;
        let state1 = 0xdeadbeefdeadbeef;
        let (f0, f1) = XorShift128Rng { state0, state1 }.next();
        let mat = XorShift128Rng::build_matrix();
        let state = (state1 as u128) << 64 | state0 as u128;
        let forward = state * mat;
        let s0 = ((forward << 64) >> 64) as u64;
        let s1 = (forward >> 64) as u64;
        assert_eq!((f0, f1), (s0, s1));
    }

    #[test]
    fn test_xs128_invert() {
        let state0 = 0x1337133713371337;
        let state1 = 0xdeadbeefdeadbeef;
        // eprintln!("{:?}", XorShift128Rng::build_matrix().inv());
        let (f0, f1) = XorShift128Rng { state0, state1 }.next();
        let (r0, r1) = invert(f0, f1);
        assert_eq!((state0, state1), (r0, r1));
    }
}

/*
// precomputed
BitMatrix128([
    0b00000000000000000000000000000000000000000000000000000000000000010000000000000000010000000000000000000000100000000000000000000001,
    0b00000000000000000000000000000000000000000000000000000000000000100000000000000000100000000000000000000001000000000000000000000010,
    0b00000000000000000000000000000000000000000000000000000000000001000000000000000001000000000000000000000010000000000000000000000100,
    0b00000000000000000000000000000000000000000000000000000000000010000000000000000010000000000000000000000100000000000000000000001000,
    0b00000000000000000000000000000000000000000000000000000000000100000000000000000100000000000000000000001000000000000000000000010000,
    0b00000000000000000000000000000000000000000000000000000000001000000000000000001000000000000000000000010000000000000000000000100000,
    0b00000000000000000000000000000000000000000000000000000000010000000000000000010000000000000000000000100000000000000000000001000000,
    0b00000000000000000000000000000000000000000000000000000000100000000000000000100000000000000000000001000000000000000000000010000000,
    0b00000000000000000000000000000000000000000000000000000001000000000000000001000000000000000000000010000000000000000000000100000000,
    0b00000000000000000000000000000000000000000000000000000010000000000000000010000000000000000000000100000000000000000000001000000000,
    0b00000000000000000000000000000000000000000000000000000100000000000000000100000000000000000000001000000000000000000000010000000000,
    0b00000000000000000000000000000000000000000000000000001000000000000000001000000000000000000000010000000000000000000000100000000000,
    0b00000000000000000000000000000000000000000000000000010000000000000000010000000000000000000000100000000000000000000001000000000000,
    0b00000000000000000000000000000000000000000000000000100000000000000000100000000000000000000001000000000000000000000010000000000000,
    0b00000000000000000000000000000000000000000000000001000000000000000001000000000000000000000010000000000000000000000100000000000000,
    0b00000000000000000000000000000000000000000000000010000000000000000010000000000000000000000100000000000000000000001000000000000000,
    0b00000000000000000000000000000000000000000000000100000000000000000100000000000000000000001000000000000000000000010000000000000000,
    0b00000000000000000000000000000000000000000000001000000000000000001000000000000000010000010000000000000000100000100000000000000001,
    0b00000000000000000000000000000000000000000000010000000000000000000000000000000000100000100000000000000001000001000000000000000010,
    0b00000000000000000000000000000000000000000000100000000000000000000000000000000001000001000000000000000010000010000000000000000100,
    0b00000000000000000000000000000000000000000001000000000000000000000000000000000010000010000000000000000100000100000000000000001000,
    0b00000000000000000000000000000000000000000010000000000000000000000000000000000100000100000000000000001000001000000000000000010000,
    0b00000000000000000000000000000000000000000100000000000000000000000000000000001000001000000000000000010000010000000000000000100000,
    0b00000000000000000000000000000000000000001000000000000000000000000000000000010000010000000000000000100000100000000000000001000000,
    0b00000000000000000000000000000000000000010000000000000000000000000000000000100000100000000000000001000001000000000000000010000000,
    0b00000000000000000000000000000000000000100000000000000000000000000000000001000001000000000000000010000010000000000000000100000000,
    0b00000000000000000000000000000000000001000000000000000000000000000000000010000010010000000000000100000100100000000000001000000001,
    0b00000000000000000000000000000000000010000000000000000000000000000000000100000100100000000000001000001001000000000000010000000010,
    0b00000000000000000000000000000000000100000000000000000000000000000000001000001001000000000000010000010010000000000000100000000100,
    0b00000000000000000000000000000000001000000000000000000000000000000000010000010010000000000000100000100100000000000001000000001000,
    0b00000000000000000000000000000000010000000000000000000000000000000000100000100100000000000001000001001000000000000010000000010000,
    0b00000000000000000000000000000000100000000000000000000000000000000001000001001000000000000010000010010000000000000100000000100000,
    0b00000000000000000000000000000001000000000000000000000000000000000010000010010000000000000100000100100000000000001000000001000000,
    0b00000000000000000000000000000010000000000000000000000000000000000100000100100000000000001000001001000000000000010000000010000000,
    0b00000000000000000000000000000100000000000000000000000000000000001000001001000000010000010000010010000000100000100000000100000001,
    0b00000000000000000000000000001000000000000000000000000000000000000000010010000000100000100000100100000001000001000000001000000010,
    0b00000000000000000000000000010000000000000000000000000000000000000000100100000001000001000001001000000010000010000000010000000100,
    0b00000000000000000000000000100000000000000000000000000000000000000001001000000010000010000010010000000100000100000000100000001000,
    0b00000000000000000000000001000000000000000000000000000000000000000010010000000100000100000100100000001000001000000001000000010000,
    0b00000000000000000000000010000000000000000000000000000000000000000100100000001000001000001001000000010000010000000010000000100000,
    0b00000000000000000000000100000000000000000000000000000000000000001001000000010000010000010010000000100000100000000100000001000000,
    0b00000000000000000000001000000000000000000000000000000000000000000010000000100000100000100100000001000001000000001000000010000000,
    0b00000000000000000000010000000000000000000000000000000000000000000100000001000001000001001000000010000010000000010000000100000000,
    0b00000000000000000000100000000000000000000000000000000000000000001000000010000010010010010000000100000100100000100000001000000001,
    0b00000000000000000001000000000000000000000000000000000000000000000000000100000100100100100000001000001001000001000000010000000010,
    0b00000000000000000010000000000000000000000000000000000000000000000000001000001001001001000000010000010010000010000000100000000100,
    0b00000000000000000100000000000000000000000000000000000000000000000000010000010010010010000000100000100100000100000001000000001000,
    0b00000000000000001000000000000000000000000000000000000000000000000000100000100100100100000001000001001000001000000010000000010000,
    0b00000000000000010000000000000000000000000000000000000000000000000001000001001001001000000010000010010000010000000100000000100000,
    0b00000000000000100000000000000000000000000000000000000000000000000010000010010010010000000100000100100000100000001000000001000000,
    0b00000000000001000000000000000000000000000000000000000000000000000100000100100100100000001000001001000001000000010000000010000000,
    0b00000000000010000000000000000000000000000000000000000000000000001000001001001001010000010000010010000010100000100000000100000001,
    0b00000000000100000000000000000000000000000000000000000000000000000000010010010010100000100000100100000101000001000000001000000010,
    0b00000000001000000000000000000000000000000000000000000000000000000000100100100101000001000001001000001010000010000000010000000100,
    0b00000000010000000000000000000000000000000000000000000000000000000001001001001010000010000010010000010100000100000000100000001000,
    0b00000000100000000000000000000000000000000000000000000000000000000010010010010100000100000100100000101000001000000001000000010000,
    0b00000001000000000000000000000000000000000000000000000000000000000100100100101000001000001001000001010000010000000010000000100000,
    0b00000010000000000000000000000000000000000000000000000000000000001001001001010000010000010010000010100000100000000100000001000000,
    0b00000100000000000000000000000000000000000000000000000000000000000010010010100000100000100100000101000001000000001000000010000000,
    0b00001000000000000000000000000000000000000000000000000000000000000100100101000001000001001000001010000010000000010000000100000000,
    0b00010000000000000000000000000000000000000000000000000000000000001001001010000010010010010000010100000100100000100000001000000001,
    0b00100000000000000000000000000000000000000000000000000000000000000010010100000100100100100000101000001001000001000000010000000010,
    0b01000000000000000000000000000000000000000000000000000000000000000100101000001001001001000001010000010010000010000000100000000100,
    0b10000000000000000000000000000000000000000000000000000000000000001001010000010010010010000010100000100100000100000001000000001000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000100000000000000000000001,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000001000000000000000000000010,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000010000000000000000000000100,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000100000000000000000000001000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000001000000000000000000000010000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000010000000000000000000000100000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000100000000000000000000001000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000001000000000000000000000010000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000010000000000000000000000100000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000100000000000000000000001000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000001000000000000000000000010000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000010000000000000000000000100000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000100000000000000000000001000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000100000000000000000000001000000000000000000000010000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000001000000000000000000000010000000000000000000000100000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000010000000000000000000000100000000000000000000001000000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000100000000000000000000001000000000000000000000010000000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000001000000000000000010000010000000000000000100000100000000000000001,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000000100000100000000000000001000001000000000000000010,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000001000001000000000000000010000010000000000000000100,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000010000010000000000000000100000100000000000000001000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000000100000100000000000000001000001000000000000000010000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000001000001000000000000000010000010000000000000000100000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000010000010000000000000000100000100000000000000001000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000100000100000000000000001000001000000000000000010000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000001000001000000000000000010000010000000000000000100000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000010000010000000000000000100000100000000000000001000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000100000100000000000000001000001000000000000000010000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000001000001000000000000000010000010000000000000000100000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000010000010000000000000000100000100000000000000001000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000100000100000000000000001000001000000000000000010000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000001000001000000000000000010000010000000000000000100000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000010000010000000000000000100000100000000000000001000000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000100000100000000000000001000001000000000000000010000000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000001000001000000000010000010000010000000000100000100000000000000001,
    0b00000000000000000000000000000000000000000000000000000000000000000000010000000000100000100000100000000001000001000000000000000010,
    0b00000000000000000000000000000000000000000000000000000000000000000000100000000001000001000001000000000010000010000000000000000100,
    0b00000000000000000000000000000000000000000000000000000000000000000001000000000010000010000010000000000100000100000000000000001000,
    0b00000000000000000000000000000000000000000000000000000000000000000010000000000100000100000100000000001000001000000000000000010000,
    0b00000000000000000000000000000000000000000000000000000000000000000100000000001000001000001000000000010000010000000000000000100000,
    0b00000000000000000000000000000000000000000000000000000000000000001000000000010000010000010000000000100000100000000000000001000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000000100000100000100000000001000001000000000000000010000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000001000001000001000000000010000010000000000000000100000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000010000010000010000000000100000100000000000000001000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000000100000100000100000000001000001000000000000000010000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000001000001000001000000000010000010000000000000000100000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000010000010000010000000000100000100000000000000001000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000100000100000100000000001000001000000000000000010000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000001000001000001000000000010000010000000000000000100000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000010000010000010000000000100000100000000000000001000000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000100000100000100000000001000001000000000000000010000000000000000,
    0b00000000000000000000000000000000000000000000000000000000000000001000001000001000010000010000010000000000100000100000000000000001,
    0b00000000000000000000000000000000000000000000000000000000000000000000010000010000100000100000100000000001000001000000000000000010,
    0b00000000000000000000000000000000000000000000000000000000000000000000100000100001000001000001000000000010000010000000000000000100,
    0b00000000000000000000000000000000000000000000000000000000000000000001000001000010000010000010000000000100000100000000000000001000,
    0b00000000000000000000000000000000000000000000000000000000000000000010000010000100000100000100000000001000001000000000000000010000,
    0b00000000000000000000000000000000000000000000000000000000000000000100000100001000001000001000000000010000010000000000000000100000,
    0b00000000000000000000000000000000000000000000000000000000000000001000001000010000010000010000000000100000100000000000000001000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000010000100000100000100000000001000001000000000000000010000000,
    0b00000000000000000000000000000000000000000000000000000000000000000000100001000001000001000000000010000010000000000000000100000000,
    0b00000000000000000000000000000000000000000000000000000000000000000001000010000010000010000000000100000100000000000000001000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000010000100000100000100000000001000001000000000000000010000000000,
    0b00000000000000000000000000000000000000000000000000000000000000000100001000001000001000000000010000010000000000000000100000000000,
    0b00000000000000000000000000000000000000000000000000000000000000001000010000010000010000000000100000100000000000000001000000000000,
])
*/
